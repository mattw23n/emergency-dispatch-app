stages:
  # - Static Analysis
  - Security Testing
  - Release
  - Deploy

# flake8:
#   stage: Static Analysis
#   image: python:3.13-slim
#   before_script:
#     - python -V
#     - python -m pip install flake8
#   script:
#     - flake8 src | tee flake8_report.txt
#   artifacts:
#     when: on_failure
#     paths:
#       - flake8_report.txt

# pylint:
#   stage: Static Analysis
#   image: python:3.13-slim
#   before_script:
#     - python -V
#     - python -m pip install -r requirements.txt
#     - python -m pip install pylint
#   script:
#     - pylint --fail-under=7 src | tee pylint_report.txt
#   artifacts:
#     when: always
#     paths:
#       - pylint_report.txt

semgrep:
  stage: Security Testing
  image: returntocorp/semgrep
  script: ["semgrep ci --config p/owasp-top-ten"]

trivy:
  stage: Security Testing
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]     # override entrypoint so we call trivy directly
  script: ["trivy fs --severity CRITICAL,HIGH ."]

gitleaks:
  stage: Security Testing
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]  # override entrypoint so we call gitleaks directly
  script: ["gitleaks detect --source . --no-git -v"]

# based on: https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Docker.gitlab-ci.yml
release-image:
  stage: Release
  image: docker:28.3.2
  services:
    - docker:28.3.2-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --pull -t "$CI_REGISTRY_IMAGE/$CI_COMMIT_BRANCH:$CI_COMMIT_SHA" .
    - docker push "$CI_REGISTRY_IMAGE/$CI_COMMIT_BRANCH:$CI_COMMIT_SHA"

deploy-ecs:
  stage: Deploy
  image: 'registry.gitlab.com/gitlab-org/cloud-deploy/aws-ecs:latest'
  environment:
    name: production-ecs
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  script:
    - ecs update-task-definition